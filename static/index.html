<!DOCTYPE html>
<title>Steampunk IRC</title>
<style>
* {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}

html {
  font-family: "Helvetica Neue", Helvetica;
  font-size: 0;
}

#users {
  font-size: 14px;
  background: #f0f0f0;
  position: absolute;
  width: 20%;
  top: 0px;
  left: 0px;
  bottom: 0px;
  overflow: auto;
}

#users .user {
  padding: 8px;
}

#users .user:first-child {
  border-top: none;
}

#users .user {
  border-top: 1px dotted gray;
}

#messages {
  padding: 0;
  font-size: 14px;
  position: absolute;
  width: 80%;
  top: 0px;
  right: 0px;
  bottom: 36px;
  overflow: auto;
}

#messages button.fetch-more {
  display: block;
  width: 100%;
  padding: 4px;
  border: none;
  background: #f0f0f0;
  color: gray;
  font: inherit;
  cursor: pointer;
}

#messages button.fetch-more:hover {
  background: black;
  color: white;
}

#messages .log {
  padding: 4px;
}

#messages .log.error {
  color: firebrick;
  font-weight: bold;
}

#messages .log.info {
  color: gray;
}

#messages .log.echo {
  border-left: 3px solid #c0c0c0;
  margin-top: 4px;
  margin-bottom: 4px;
  padding-left: 4px;
  color: gray;
}

#messages .log.old-msg {
  color: gray;
}

#messages .log.private-msg {
  background: firebrick;
  color: white;
}

#messages .log.private-msg .nick {
  color: white;
}

#messages .log .nick {
  color: steelblue;
  font-weight: bold;
}

#messages .log .target {
  font-weight: bold;
}

#messages .log time {
  float: right;
  font-size: 12px;
  color: gray;
}

#input-area {
  position: absolute;
  padding: 6px;
  bottom: 0px;
  right: 0px;
  height: 36px;
  width: 80%;
  background: #505050;
  font-size: 18px;
}

#cmd {
  width: 100%;
  border: none;
  background: inherit;
  font: inherit;
  color: white;
}

#cmd:focus {
  outline: none;
}
</style>
<div id="users"></div>
<div id="messages"></div>
<div id="input-area"><input type="text" id="cmd"></div>
<script type="text/html" id="message-template">
  <div class="log message <%- targetType %>">
    <span class="nick"><%- nick %></span> 
    @ 
    <span class="target"><%- target %></span>:
    <%= html %>
    <time data-timestamp="<%- timestamp %>"><%- prettyTime %></time>
  </div>
</script>
<script src="socket.io/socket.io.js"></script>
<script src="jquery.min.js"></script>
<script src="scrollto.jquery.min.js"></script>
<script src="autoscroll-log.jquery.js"></script>
<script src="underscore.min.js"></script>
<script src="users.js"></script>
<script src="user-list-view.js"></script>
<script src="pretty-date.js"></script>
<script src="linkify.js"></script>
<script>
function logMessage(options) {
  var target = options.target;
  var targetType = (target[0] == "#") ? "channel-msg" : "private-msg";
  var classSuffix = options.className ? (' ' + options.className) : '';
  var timestamp = options.timestamp || Date.now();
  var html = _.template($("#message-template").text(), {
    targetType: targetType + classSuffix,
    nick: options.nick,
    target: target,
    html: enrichMessageText(options.message),
    timestamp: timestamp.toString(),
    prettyTime: prettyDate(timestamp)
  });
  if (options.where)
    $(html.trim()).appendTo(options.where)
  else
    $(html.trim()).addToLog("#messages", options.forceScroll);
}

var irc = {
  socket: null,
  nick: "UNKNOWN",
  timeDelta: 0,
  users: new Users(),
  say: function(target, message) {
    this.socket.emit('say', {target: target, message: message});
    logMessage({
      target: target,
      className: "self-msg",
      nick: irc.nick,
      message: message,
      forceScroll: true
    });
  },
  join: function(channel) {
    this.socket.emit('join', {channel: channel});
  },
  part: function(channel) {
    this.users.removeChannel(channel);
    this.socket.emit('part', {channel: channel});
  },
  whois: function(nick) {
    this.socket.emit('whois', {nick: nick});
  },
  getNames: function(channel) {
    this.socket.emit('names', {channel: channel});
  },
  setCustomGlobalMetadata: function(key, value) {
    this.socket.emit('set-custom-global-metadata', {key: key, value: value});
  },
  getCustomGlobalMetadata: function(cb) {
    this.socket.emit('get-custom-global-metadata');
    this.socket.once('custom-global-metadata', cb);
  },
  getLoggedMessages: function(start, end, cb) {
    var self = this;
    
    function onLoggedMessages(data) {
      if (data.start == (start || 0) && data.end == end) {
        self.socket.removeListener('logged-messages', onLoggedMessages);
        cb(data.messages);
      }
    }
    
    this.socket.emit('get-logged-messages', {start: start, end: end});
    self.socket.addListener('logged-messages', onLoggedMessages);
  }
};

function splitAtSpace(input) {
  var firstSpace = input.indexOf(" ");
  var arg = "";
  var cmd = input;
  if (firstSpace != -1) {
    cmd = input.slice(0, firstSpace);
    arg = input.slice(firstSpace).trim();
  }
  return [cmd, arg];
}

function handleCommand(input) {
  var parts = splitAtSpace(input);
  var cmd = parts[0];
  var arg = parts[1];
  
  if (cmd == "/who") {
    if (!arg)
      return log("error", "Please specify a channel to list names of, or " +
                 "a nick to get more information on.");
    if (arg[0] == '#') {
      log("Looking for people in " + arg + "...");
      irc.getNames(arg);
    } else {
      irc.whois(arg);
    }
  } else if (cmd == "/join") {
    if (!arg)
      return log("error", "Please specify a channel to join.");
    log("Attempting to join " + arg + "...");
    irc.join(arg);
  } else if (cmd == "/leave") {
    if (!arg)
      return log("error", "Please specify a channel to leave.");
    log("Attempting to leave " + arg + "...");
    irc.part(arg);
  } else
    log("error", "Unrecognized command.");
}

function getChannelAutocompletions(to, channels) {
  return _.filter(channels, function(channel) {
    return (channel.indexOf(to) == 0);
  });
}

function handleSay(input) {
  var parts = splitAtSpace(input);
  var to = parts[0];
  var msg = parts[1];
  
  if (to[0] == '@') {
    to = to.slice(1);
    if (!to)
      return log("error", "Please specify a user after @.");
  } else {
    var channels = irc.users.getAllChannels();
    var matches = getChannelAutocompletions(to, channels);
    if (matches.length == 0)
      return log("error", "Unknown channel. Please choose from: " +
                 channels.join(", ") + ".");
    if (matches.length > 1)
      return log("error",
                 "I'm not sure whether you mean " + matches.join(" or ") +
                 ". Please be more specific.");
    to = matches[0];
  }

  if (!msg)
    return log("error",
               "I understand that you want to talk to " + to + ", but " +
               "I need a message.");
  irc.say(to, msg);
}

$("#cmd").keyup(function(event) {
  if (event.keyCode == 13) {
    var input = $(this).val().trim();
    $(this).val('');
    if (!input)
      return;
    log('echo', input);
    if (input[0] == '/')
      handleCommand(input);
    else if (input[0] == '@' || input[0] == '#')
      handleSay(input);
    else
      log("error", "Your input should start with /, #, or @.");
  }
});

function enrichMessageText(text) {
  return linkifyTextToHTML(text, function(anchor) {
    anchor.setAttribute('target', '_blank');
    anchor.setAttribute('rel', 'nofollow');
  });
}

function log(type, msg) {
  if (msg === undefined) {
    msg = type;
    type = "info";
  }
  $('<div class="log ' + type + '"></div>').text(msg)
    .addToLog("#messages");
}

var Login = {
  KEY: "steampunk_irc_login_info",
  set: function(username, password) {
    localStorage[this.KEY] = JSON.stringify({
      username: username,
      password: password
    });
  },
  get: function() {
    try {
      return JSON.parse(localStorage[this.KEY]);
    } catch (e) {
      return null;
    }
  },
  clear: function() {
    delete localStorage[this.KEY];
  }
};

function showLoggedMessages() {
  var CHUNK_SIZE = 10;
  var lastChunk = -CHUNK_SIZE;
  
  function logOldMessage(msg, options) {
    logMessage(_.extend({
      target: msg.to,
      className: "old-msg",
      nick: msg.nick,
      message: msg.text,
      timestamp: msg.timestamp + irc.timeDelta,
    }, options));
  }
  
  irc.getLoggedMessages(lastChunk, undefined, function(messages) {
    if (messages.length) {
      var fetchMore = $('<button class="fetch-more">Click here to see ' +
                        + CHUNK_SIZE + ' more archived messages.</button>');
      fetchMore.addToLog("#messages", true).click(function() {
        if ($(this).hasClass("loading"))
          return;
        $(this).addClass("loading");
        var oldMessages = $('<div class="old-messages"></div>');
        var newLastChunk = lastChunk - CHUNK_SIZE;
        irc.getLoggedMessages(newLastChunk, lastChunk, function(messages) {
          fetchMore.removeClass("loading");
          messages.forEach(function(msg) {
            logOldMessage(msg, {where: oldMessages});
          });
          if (messages.length == 0)
            fetchMore.fadeOut();
        });
        lastChunk = newLastChunk;
        oldMessages.insertAfter(fetchMore).hide().fadeIn();
      });
    }
    messages.forEach(function(msg) {
      logOldMessage(msg, {forceScroll: true});
    });
  });
}

$(window).ready(function() {
  var loginInfo = Login.get();
  if (!loginInfo) {
    log("error", "Please use Login.set(username, password) at the " +
        "JS console, then refresh the page to login.");
    return;
  }
  $("#cmd").focus();
  log("Connecting...");
  var socket = io.connect();
  var userListView = new UserListView(irc.users, $("#users"));
  socket.on('connect', function() {
    log("Connected. Logging in...");
    socket.emit('login', {
      username: loginInfo.username,
      password: loginInfo.password
    });
  });
  socket.on('configuration', function(config) {
    irc.nick = config.nick;
    irc.timeDelta = Date.now() - config.now;
    log("info", "Your nick is " + config.nick +
        ". You are in channels: " + config.channels.join(", ") + ".");
    config.channels.forEach(function(channel) {
      irc.getNames(channel);
    });
    showLoggedMessages();
  });
  socket.on('join', function(info) {
    irc.users.add([info.nick], info.channel);
    log("info", info.nick + " has joined " + info.channel + ".");
  });
  socket.on('part', function(info) {
    irc.users.remove([info.nick], info.channel);
    log("info", info.nick + " has left " + info.channel + ".");
  });
  socket.on('whois', function(info) {
    if (!info)
      return log("error", "No information is available on that user.");
    log(info.nick + " is " + info.realname + ". They are in the " +
        "following channels: " + info.channels.join(", ") + ".");
  });
  socket.on('quit', function(info) {
    irc.users.remove([info.nick]);
    log("info", info.nick + " has left the building.");
  });
  socket.on('kick', function(info) {
    irc.users.remove([info.nick], info.channel);
    log("info", info.nick + " has been kicked from " + info.channel + ".");
  });
  socket.on('kill', function(info) {
    irc.users.remove([info.nick]);
    log("info", info.nick + " has been killed from the server.");
  });
  socket.on('names', function(info) {
    var nicks = Object.keys(info.nicks);
    irc.users.add(nicks, info.channel);
    log("info", "Inside " + info.channel + " are: " +
        nicks.join(", ") + ".");
  });
  socket.on('nick', function(info) {
    if (info.oldnick == irc.nick)
      irc.nick = info.newnick;
    irc.users.rename(info.oldnick, info.newnick);
    log(info.oldnick + " is now known as " + info.newnick + ".");
  });
  socket.on('message', function(msg) {
    logMessage({
      target: msg.to,
      nick: msg.nick,
      message: msg.text
    });
  });
  ['go-away', 'message', 'names', 'topic', 'nick', 'join', 'part',
   'message', 'custom-global-metadata', 'change-custom-global-metadata',
   'pong', 'logged-messages', 'configuration', 
   'irc-error', 'whois'].forEach(function(event) {
    socket.on(event, function(data) {
      console.log("MESSAGE:", event, data);
    });
  });
  socket.on('irc-error', function(info) {
    log("error", "Alas, an IRC error occurred: " + info.command);
  });
  socket.on('disconnect', function() {
    log("error", "The connection to the server has been lost.");
  });
  irc.socket = socket;
});

setInterval(function() {
  $("time[data-timestamp]").each(function() {
    var timestamp = $(this).attr("data-timestamp");
    $(this).text(prettyDate(timestamp));
  });
}, 60000);
</script>
