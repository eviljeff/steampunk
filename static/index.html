<!DOCTYPE html>
<title>Steampunk IRC</title>
<style>
* {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}

html {
  font-family: "Helvetica Neue", Helvetica;
  font-size: 0;
}

#users {
  font-size: 14px;
  background: #f0f0f0;
  position: absolute;
  width: 20%;
  top: 0px;
  left: 0px;
  bottom: 0px;
  overflow: auto;
}

#users .user {
  padding: 8px;
}

#users .user:first-child {
  border-top: none;
}

#users .user {
  border-top: 1px dotted gray;
}

#messages {
  padding: 0;
  font-size: 14px;
  position: absolute;
  width: 80%;
  top: 0px;
  right: 0px;
  bottom: 36px;
  overflow: auto;
}

#messages button.fetch-more {
  display: block;
  width: 100%;
  padding: 4px;
  border: none;
  background: #f0f0f0;
  color: gray;
  font: inherit;
  cursor: pointer;
}

#messages button.fetch-more:hover {
  background: black;
  color: white;
}

#messages .log {
  padding: 4px;
}

#messages .log.error {
  color: firebrick;
  font-weight: bold;
}

#messages .log.info {
  color: gray;
}

#messages .log.echo {
  border-left: 3px solid #c0c0c0;
  margin-top: 4px;
  margin-bottom: 4px;
  padding-left: 4px;
  color: gray;
}

#messages .log.old-msg {
  color: gray;
}

#messages .log.private-msg {
  background: firebrick;
  color: white;
}

#messages .log.private-msg .nick {
  color: white;
}

#messages .log .nick {
  color: steelblue;
  font-weight: bold;
}

#messages .log .target {
  font-weight: bold;
}

#messages .log time {
  float: right;
  font-size: 12px;
  color: gray;
}

#input-area {
  position: absolute;
  padding: 6px;
  bottom: 0px;
  right: 0px;
  height: 36px;
  width: 80%;
  background: #505050;
  font-size: 18px;
}

#cmd {
  width: 100%;
  border: none;
  background: inherit;
  font: inherit;
  color: white;
}

#cmd:focus {
  outline: none;
}
</style>
<div id="users"></div>
<div id="messages"></div>
<div id="input-area"><input type="text" id="cmd"></div>
<script type="text/html" id="message-template">
  <div class="log message <%- targetType %>">
    <span class="nick"><%- nick %></span> 
    @ 
    <span class="target"><%- target %></span>:
    <%= html %>
    <time data-timestamp="<%- timestamp %>"><%- prettyTime %></time>
  </div>
</script>
<script src="socket.io/socket.io.js"></script>
<script src="jquery.min.js"></script>
<script src="scrollto.jquery.min.js"></script>
<script src="underscore.min.js"></script>
<script src="require.min.js"></script>
<script>
function Login(key) {
  key = key || "steampunk_irc_login_info";
  
  return {
    set: function(username, password) {
      try {
        localStorage[key] = JSON.stringify({
          username: username,
          password: password
        });
      } catch (e) {}
    },
    get: function() {
      try {
        return JSON.parse(localStorage[key]);
      } catch (e) {
        return null;
      }
    },
    clear: function() {
      delete localStorage[key];
    }
  };
}

function showLoggedMessages(irc, logArea) {
  var CHUNK_SIZE = 10;
  var lastChunk = -CHUNK_SIZE;
  
  function logOldMessage(msg, options) {
    logArea.logSocialMessage(_.extend({
      target: msg.to,
      className: "old-msg",
      nick: msg.nick,
      message: msg.text,
      timestamp: msg.timestamp + irc.timeDelta,
    }, options));
  }
  
  irc.getLoggedMessages(lastChunk, undefined, function(messages) {
    if (messages.length) {
      var fetchMore = $('<button class="fetch-more">Click here to see ' +
                        + CHUNK_SIZE + ' more archived messages.</button>');
      fetchMore.click(function() {
        if ($(this).hasClass("loading"))
          return;
        $(this).addClass("loading");
        var oldMessages = $('<div class="old-messages"></div>');
        var newLastChunk = lastChunk - CHUNK_SIZE;
        irc.getLoggedMessages(newLastChunk, lastChunk, function(messages) {
          fetchMore.removeClass("loading");
          messages.forEach(function(msg) {
            logOldMessage(msg, {where: oldMessages});
          });
          if (messages.length == 0)
            fetchMore.fadeOut();
        });
        lastChunk = newLastChunk;
        oldMessages.insertAfter(fetchMore).hide().fadeIn();
      });
      logArea.logElement(fetchMore);
    }
    messages.forEach(function(msg) {
      logOldMessage(msg, {forceScroll: true});
    });
  });
}

require([
  "log-area",
  "irc",
  "user-list-view",
  "cmdline"
], function(LogArea, IRC, UserListView, CommandLine) {
  var login = new Login();
  var loginInfo = login.get();
  var logArea = new LogArea({
    element: $("#messages"),
    socialMessageTemplate: $("#message-template").text()
  });
  var log = logArea.log;
  var irc = new IRC();
  var userListView = new UserListView(irc.users, $("#users"));
  var cmdLine = new CommandLine($("#cmd"), irc, logArea, login);

  if (loginInfo) {
    cmdLine.execute("/login " + loginInfo.username + " " + 
                    loginInfo.password);
  } else
    log("Please use the /login command to log in.");

  cmdLine.el.focus();
  irc.on('connect', function() { log("Connected. Logging in..."); });
  irc.on('login', function() {
    var channels = irc.users.getAllChannels();
    log("info", "Your nick is " + irc.nick +
        ". You are in channels: " + channels.join(", ") + ".");
    channels.forEach(function(channel) { irc.getNames(channel); });
    showLoggedMessages(irc, logArea);
  });
  irc.on('join', function(info) {
    log("info", info.nick + " has joined " + info.channel + ".");
  });
  irc.on('part', function(info) {
    log("info", info.nick + " has left " + info.channel + ".");
  });
  irc.on('whois', function(info) {
    if (!info)
      return log("error", "No information is available on that user.");
    log(info.nick + " is " + info.realname + ". They are in the " +
        "following channels: " + info.channels.join(", ") + ".");
  });
  irc.on('quit', function(info) {
    log("info", info.nick + " has left the building.");
  });
  irc.on('kick', function(info) {
    log("info", info.nick + " has been kicked from " + info.channel + ".");
  });
  irc.on('kill', function(info) {
    log("info", info.nick + " has been killed from the server.");
  });
  irc.on('names', function(info) {
    var nicks = Object.keys(info.nicks);
    log("info", "Inside " + info.channel + " are: " +
        nicks.join(", ") + ".");
  });
  irc.on('nick', function(info) {
    log(info.oldnick + " is now known as " + info.newnick + ".");
  });
  irc.on('message', function(msg) {
    logArea.logSocialMessage({
      target: msg.to,
      nick: msg.nick,
      message: msg.text
    });
  });
  irc.on('go-away', function() {
    log("error", "The server does not seem to like you. Consider trying " +
        "a different username or password.");
  });
  irc.on('irc-error', function(info) {
    log("error", "Alas, an IRC error occurred: " + info.command);
  });
  irc.on('disconnect', function() {
    log("error", "The connection to the server has been lost.");
  });
});
</script>
